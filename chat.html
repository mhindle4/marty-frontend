<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Marty â€“ Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #0b0c10; color: #eaf0f1; }
    .shell { max-width: 800px; margin: 0 auto; padding: 24px 16px 32px; }
    nav { margin-bottom: 24px; text-align: center; }
    nav a { color: #66fcf1; margin: 0 12px; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    .hero { text-align: center; margin-top: 8px; }
    .hero img { width: 120px; height: 120px; border-radius: 50%; border: 3px solid #66fcf1; object-fit: cover; }
    h1 { margin: 12px 0 16px; text-align: center; }

    .chat {
      background: #111417; border-radius: 16px; padding: 16px;
      min-height: 50vh; display: flex; flex-direction: column; gap: 12px;
      overflow-y: auto; scroll-behavior: smooth;
    }

    .row { display: flex; align-items: flex-start; gap: 8px; }
    .row.me { justify-content: flex-end; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; flex: 0 0 40px; object-fit: cover; border: 2px solid #2b2f36; }
    .spacer { width: 40px; height: 40px; }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    .msg {
      padding: 12px 14px; border-radius: 12px; max-width: 75%; word-wrap: break-word;
      opacity: 0; animation: fadeInUp 220ms ease-out both;
    }
    .me .msg { background: #1f2833; }
    .bot .msg { background: #0e6655; position: relative; }

    /* Typing dots */
    .typing.msg { background: #0e6655; }
    .dots { display: inline-flex; gap: 4px; vertical-align: middle; }
    .dot { width: 6px; height: 6px; background: #cfeee9; border-radius: 50%; opacity: 0.6; animation: bounce 1s infinite ease-in-out; }
    .dot:nth-child(2) { animation-delay: .15s; }
    .dot:nth-child(3) { animation-delay: .3s; }
    @keyframes bounce { 0%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-4px); opacity: 1; } }

    form { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 12px 0; align-items: center; }
    input[type="text"] { padding: 12px; border-radius: 10px; border: 1px solid #2b2f36; background:#0d1117; color:#eaf0f1; }
    button { padding: 12px 16px; border: 0; border-radius: 10px; background: #45a29e; color: #0b0c10; font-weight: 700; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    audio { display: none; }  /* hide audio bar */
    .status { display: none; }

    /* Speaking visualizer inside bubble */
    .speaking {
      display: inline-flex; align-items: flex-end; gap: 3px; height: 16px; margin-left: 8px;
    }
    .speaking .bar {
      width: 3px; height: 4px; background: #66fcf1; border-radius: 1px;
      animation: eq 1s infinite ease-in-out;
    }
    .speaking .bar:nth-child(2) { animation-delay: .1s; }
    .speaking .bar:nth-child(3) { animation-delay: .2s; }
    .speaking .bar:nth-child(4) { animation-delay: .3s; }
    @keyframes eq {
      0%, 100% { height: 4px; opacity: .7; }
      50% { height: 16px; opacity: 1; }
    }

    /* Scroll to bottom */
    #scrollBtn {
      position: fixed; bottom: 90px; right: 20px;
      background: #45a29e; color: #0b0c10; border: none; border-radius: 50%;
      width: 50px; height: 50px; font-size: 24px;
      display: none; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    #scrollBtn:hover { background: #66fcf1; }

    /* Mic push-to-talk */
    #mic.listening {
      background: #e85d75; color: #0b0c10; animation: micPulse 1s infinite;
    }
    @keyframes micPulse {
      0%   { box-shadow: 0 0 0 0 rgba(232,93,117,0.6); }
      70%  { box-shadow: 0 0 0 14px rgba(232,93,117,0); }
      100% { box-shadow: 0 0 0 0 rgba(232,93,117,0); }
    }
  </style>
</head>
<body>
  <div class="shell">
    <nav aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="chat.html" aria-current="page">Chat</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
    </nav>

    <div class="hero">
      <img src="marty.jpg?t=1" alt="Marty profile photo">
    </div>

    <h1>Chat with Marty</h1>

    <div id="chat" class="chat" aria-live="polite" aria-label="Conversation"></div>

    <form id="chatForm" autocomplete="off">
      <input id="message" type="text" placeholder="Say hi to Martyâ€¦" />
      <button type="submit" id="sendBtn">Send</button>
      <button type="button" id="mic" aria-label="Hold to talk" title="Hold to talk">ðŸŽ¤</button>
    </form>

    <audio id="player" preload="auto"></audio>
  </div>

  <button id="scrollBtn" title="Scroll to bottom">â¬‡</button>

  <script>
    const API_BASE = "https://marty-backend.onrender.com";
    const AVATAR_SRC = "marty.jpg?t=1";

    const chat = document.getElementById("chat");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("message");
    const micBtn = document.getElementById("mic");
    const sendBtn = document.getElementById("sendBtn");
    const player = document.getElementById("player");
    const scrollBtn = document.getElementById("scrollBtn");

    let userHasInteracted = false;

    function scrollToBottom() { chat.scrollTop = chat.scrollHeight; }

    function addRow(who) {
      const row = document.createElement("div");
      row.className = `row ${who}`;
      if (who === "bot") {
        const img = document.createElement("img");
        img.src = AVATAR_SRC;
        img.alt = "Marty avatar";
        img.className = "avatar";
        row.appendChild(img);
      } else {
        const spacer = document.createElement("div");
        spacer.className = "spacer";
        row.appendChild(spacer);
      }
      return row;
    }

    function addBubble(text, who) {
      const row = addRow(who);
      const bubble = document.createElement("div");
      bubble.className = "msg";
      bubble.textContent = text;
      row.appendChild(bubble);
      chat.appendChild(row);
      scrollToBottom();
      return bubble;
    }

    function addTypingBubble() {
      const row = addRow("bot");
      const bubble = document.createElement("div");
      bubble.className = "msg typing";
      const wrapper = document.createElement("span");
      wrapper.className = "dots";
      wrapper.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      bubble.appendChild(wrapper);
      row.appendChild(bubble);
      chat.appendChild(row);
      scrollToBottom();
      return () => row.remove();
    }

    async function sendToMarty(text) {
      const res = await fetch(`${API_BASE}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });
      if (!res.ok) throw new Error("Server error: " + res.status);
      return res.json();
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      userHasInteracted = true;
      const text = input.value.trim();
      if (!text) return;

      const mine = addBubble(text, "me");
      input.value = "";

      const removeTyping = addTypingBubble();
      sendBtn.disabled = true;
      micBtn.disabled = true;

      try {
        const data = await sendToMarty(mine.textContent);
        removeTyping();
        const reply = addBubble(data.text || "(no response)", "bot");

        // Add speaking visualizer inside bot bubble
        const speakViz = document.createElement("span");
        speakViz.className = "speaking";
        speakViz.innerHTML = '<span class="bar"></span><span class="bar"></span><span class="bar"></span><span class="bar"></span>';
        reply.appendChild(speakViz);

        if (data.audioUrl) {
          player.src = `${API_BASE}${data.audioUrl}?t=${Date.now()}`;
          player.addEventListener("playing", () => speakViz.style.display = "inline-flex");
          player.addEventListener("ended", () => speakViz.style.display = "none");
          player.addEventListener("pause", () => speakViz.style.display = "none");
          if (userHasInteracted) { try { await player.play(); } catch {} }
        }
      } catch (err) {
        removeTyping();
        addBubble("Error talking to server.", "bot");
        console.error(err);
      } finally {
        sendBtn.disabled = false;
        micBtn.disabled = false;
        input.focus();
      }
    });

    // Push-to-talk mic
    const RECO_LANG = "en-GB";
    let rec = null, listening = false, stopping = false, interimText = "", finalText = "";

    function createRecognizer() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert("Speech recognition not supported in this browser."); return null; }
      const r = new SR();
      r.lang = RECO_LANG;
      r.interimResults = true;
      r.continuous = true;
      r.maxAlternatives = 1;
      r.onresult = (e) => {
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const res = e.results[i];
          if (res.isFinal) { finalText += res[0].transcript + " "; interimText = ""; }
          else { interimText = res[0].transcript; }
        }
        input.value = (finalText + " " + interimText).trim();
      };
      r.onend = () => {
        if (stopping) { stopping = false; micBtn.classList.remove("listening"); listening = false; if (input.value.trim()) form.requestSubmit(); }
        else { micBtn.classList.remove("listening"); listening = false; }
      };
      r.onerror = (e) => { console.error("Speech error:", e.error); micBtn.classList.remove("listening"); listening = false; stopping = false; };
      return r;
    }

    function startPTT(ev) {
      ev.preventDefault();
      userHasInteracted = true;
      if (listening) return;
      rec = createRecognizer();
      if (!rec) return;
      interimText = ""; finalText = "";
      input.value = "";
      stopping = false;
      listening = true;
      micBtn.classList.add("listening");
      try { rec.start(); } catch {}
    }

    function stopPTT() { if (!listening || !rec) return; stopping = true; try { rec.stop(); } catch {} }

    micBtn.addEventListener("mousedown", startPTT);
    window.addEventListener("mouseup", stopPTT);
    micBtn.addEventListener("touchstart", (e) => { startPTT(e); }, { passive: false });
    window.addEventListener("touchend", () => { stopPTT(); });

    // Scroll button
    chat.addEventListener("scroll", () => {
      const atBottom = chat.scrollTop + chat.clientHeight >= chat.scrollHeight - 20;
      scrollBtn.style.display = atBottom ? "none" : "flex";
    });
    scrollBtn.addEventListener("click", scrollToBottom);
  </script>
</body>
</html>
