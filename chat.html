<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Marty â€“ Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #0b0c10; color: #eaf0f1; }
    .shell { max-width: 800px; margin: 0 auto; padding: 24px 16px 32px; }
    nav { margin-bottom: 24px; text-align: center; }
    nav a { color: #66fcf1; margin: 0 12px; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    .hero { text-align: center; margin-top: 8px; }
    .hero img { width: 120px; height: 120px; border-radius: 50%; border: 3px solid #66fcf1; object-fit: cover; }
    h1 { margin: 12px 0 16px; text-align: center; }
    .chat {
      background: #111417; border-radius: 16px; padding: 16px;
      min-height: 50vh; display: flex; flex-direction: column; gap: 12px;
      overflow-y: auto; scroll-behavior: smooth; /* <- smooth auto-scroll */
    }
    .row { display: flex; align-items: flex-start; gap: 8px; }
    .row.me { justify-content: flex-end; }
    .msg { padding: 12px 14px; border-radius: 12px; max-width: 75%; word-wrap: break-word; }
    .me .msg { background: #1f2833; }
    .bot .msg { background: #0e6655; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; flex: 0 0 40px; object-fit: cover; border: 2px solid #2b2f36; }
    form { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 12px 0; align-items: center; }
    input[type="text"] { padding: 12px; border-radius: 10px; border: 1px solid #2b2f36; background:#0d1117; color:#eaf0f1; }
    button { padding: 12px 16px; border: 0; border-radius: 10px; background: #45a29e; color: #0b0c10; font-weight: 700; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .toolbar { display: flex; gap: 8px; justify-content: space-between; align-items: center; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,1,1); white-space: nowrap; border: 0; }
    audio { display: none; } /* hide the audio bar */
    .status { font-size: 0.9em; opacity: 0.8; }
  </style>
</head>
<body>
  <div class="shell">
    <nav aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="chat.html" aria-current="page">Chat</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
    </nav>

    <div class="hero">
      <img src="marty.jpg?t=1" alt="Marty profile photo">
    </div>

    <h1>Chat with Marty</h1>

    <div id="chat" class="chat" aria-live="polite" aria-label="Conversation"></div>

    <form id="chatForm" autocomplete="off" aria-label="Send a message to Marty">
      <label class="sr-only" for="message">Message</label>
      <input id="message" type="text" placeholder="Say hi to Martyâ€¦" aria-required="true" />
      <button type="submit" id="sendBtn" title="Send message" aria-label="Send message">Send</button>
      <button type="button" id="mic" aria-label="Start voice input" title="Speak a message">ðŸŽ¤</button>
    </form>

    <div class="toolbar">
      <audio id="player" preload="auto" aria-label="Marty audio reply"></audio>
      <span id="status" class="status" role="status" aria-live="polite">Ready</span>
    </div>
  </div>

  <script>
    const API_BASE = "https://marty-backend.onrender.com";
    const chat = document.getElementById("chat");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("message");
    const micBtn = document.getElementById("mic");
    const sendBtn = document.getElementById("sendBtn");
    const player = document.getElementById("player");
    const statusEl = document.getElementById("status");
    const AVATAR_SRC = "marty.jpg?t=1";
    let userHasInteracted = false;

    function scrollToBottom() {
      chat.scrollTop = chat.scrollHeight;
    }

    function addBubble(text, who) {
      const row = document.createElement("div");
      row.className = `row ${who}`;
      row.setAttribute("role", "group");
      row.setAttribute("aria-label", who === "bot" ? "Marty message" : "Your message");

      if (who === "bot") {
        const img = document.createElement("img");
        img.src = AVATAR_SRC;
        img.alt = "Marty avatar";
        img.className = "avatar";
        row.appendChild(img);
      } else {
        const spacer = document.createElement("div");
        spacer.style.width = "40px";
        spacer.style.height = "40px";
        row.appendChild(spacer);
      }

      const bubble = document.createElement("div");
      bubble.className = "msg";
      bubble.textContent = text;

      row.appendChild(bubble);
      chat.appendChild(row);
      scrollToBottom(); // keep view pinned to latest
      return bubble;
    }

    async function sendToMarty(text) {
      statusEl.textContent = "Sendingâ€¦";
      const res = await fetch(`${API_BASE}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });
      if (!res.ok) throw new Error("Server error: " + res.status);
      return res.json();
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      userHasInteracted = true; // first click or key press unlocks audio autoplay

      const text = input.value.trim();
      if (!text) return;

      const mine = addBubble(text, "me");
      mine.parentElement.classList.add("me");
      mine.classList.add("me");

      input.value = "";
      const thinking = addBubble("â€¦thinkingâ€¦", "bot");
      thinking.parentElement.classList.add("bot");
      thinking.classList.add("bot");

      sendBtn.disabled = true;
      micBtn.disabled = true;

      try {
        const data = await sendToMarty(mine.textContent);
        thinking.textContent = data.text || "(no response)";
        scrollToBottom(); // ensure we see the completed reply
        statusEl.textContent = "Ready";

        if (data.audioUrl) {
          player.src = `${API_BASE}${data.audioUrl}?t=${Date.now()}`;
          if (userHasInteracted) {
            try { await player.play(); } catch {}
          }
        }
      } catch (err) {
        thinking.textContent = "Error talking to server.";
        statusEl.textContent = "Error";
        console.error(err);
        alert("Couldnâ€™t reach the server. Please try again.");
      } finally {
        sendBtn.disabled = false;
        micBtn.disabled = false;
        input.focus();
      }
    });

    micBtn.addEventListener("click", () => {
      userHasInteracted = true; // unlock audio autoplay path
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Speech recognition not supported in this browser. Try Chrome on desktop.");
        return;
      }

      const rec = new SpeechRecognition();
      rec.lang = "en-US";
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      micBtn.disabled = true;
      micBtn.textContent = "ðŸŽ™ï¸";
      statusEl.textContent = "Listeningâ€¦";
      rec.start();

      rec.onresult = (e) => {
        const transcript = e.results[0][0].transcript;
        input.value = transcript;
        form.requestSubmit();
      };

      rec.onend = () => {
        micBtn.disabled = false;
        micBtn.textContent = "ðŸŽ¤";
        if (statusEl.textContent === "Listeningâ€¦") statusEl.textContent = "Ready";
      };

      rec.onerror = (e) => {
        console.error("Speech error:", e.error);
        micBtn.disabled = false;
        micBtn.textContent = "ðŸŽ¤";
        statusEl.textContent = "Mic error";
        alert("Mic error: " + e.error);
      };
    });
  </script>
</body>
</html>