<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Marty â€“ Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #0b0c10; color: #eaf0f1; }
    .shell { max-width: 800px; margin: 0 auto; padding: 24px 16px 32px; }
    nav { margin-bottom: 24px; text-align: center; }
    nav a { color: #66fcf1; margin: 0 12px; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    .hero { text-align: center; margin-top: 8px; }
    .hero img { width: 120px; height: 120px; border-radius: 50%; border: 3px solid #66fcf1; object-fit: cover; }
    h1 { margin: 12px 0 16px; text-align: center; }

    .chat {
      background: #111417; border-radius: 16px; padding: 16px;
      min-height: 50vh; display: flex; flex-direction: column; gap: 12px;
      overflow-y: auto; scroll-behavior: smooth;
    }
    .row { display: flex; align-items: flex-start; gap: 8px; }
    .row.me { justify-content: flex-end; }

    /* Fade-in for message bubbles */
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    .msg {
      padding: 12px 14px; border-radius: 12px; max-width: 75%; word-wrap: break-word;
      opacity: 0; animation: fadeInUp 220ms ease-out both;
    }
    .me .msg { background: #1f2833; }
    .bot .msg { background: #0e6655; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; flex: 0 0 40px; object-fit: cover; border: 2px solid #2b2f36; }

    /* Typing indicator (three bouncing dots) */
    .typing { background: #0e6655; }
    .dots { display: inline-flex; gap: 4px; vertical-align: middle; }
    .dot { width: 6px; height: 6px; background: #cfeee9; border-radius: 50%; opacity: 0.6; animation: bounce 1s infinite ease-in-out; }
    .dot:nth-child(2) { animation-delay: .15s; }
    .dot:nth-child(3) { animation-delay: .3s; }
    @keyframes bounce { 0%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-4px); opacity: 1; } }

    form { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 12px 0; align-items: center; }
    input[type="text"] { padding: 12px; border-radius: 10px; border: 1px solid #2b2f36; background:#0d1117; color:#eaf0f1; }
    button { padding: 12px 16px; border: 0; border-radius: 10px; background: #45a29e; color: #0b0c10; font-weight: 700; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .toolbar { display: flex; gap: 8px; justify-content: space-between; align-items: center; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,1,1); white-space: nowrap; border: 0; }
    audio { display: none; }                 /* hide the audio bar */
    .status { display: none; }               /* hide any visible status text */

    /* Scroll to bottom button */
    #scrollBtn {
      position: fixed; bottom: 90px; right: 20px;
      background: #45a29e; color: #0b0c10; border: none; border-radius: 50%;
      width: 50px; height: 50px; font-size: 24px;
      display: none; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    #scrollBtn:hover { background: #66fcf1; }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .chat { scroll-behavior: auto; }
      .msg { animation: none; opacity: 1; }
      .dot { animation: none; opacity: .8; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <nav aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="chat.html" aria-current="page">Chat</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
    </nav>

    <div class="hero">
      <img src="marty.jpg?t=1" alt="Marty profile photo">
    </div>

    <h1>Chat with Marty</h1>

    <div id="chat" class="chat" aria-live="polite" aria-label="Conversation"></div>

    <form id="chatForm" autocomplete="off" aria-label="Send a message to Marty">
      <label class="sr-only" for="message">Message</label>
      <input id="message" type="text" placeholder="Say hi to Martyâ€¦" aria-required="true" />
      <button type="submit" id="sendBtn" title="Send message" aria-label="Send message">Send</button>
      <button type="button" id="mic" aria-label="Start voice input" title="Speak a message">ðŸŽ¤</button>
    </form>

    <div class="toolbar">
      <audio id="player" preload="auto" aria-label="Marty audio reply"></audio>
      <span id="status" class="status" role="status" aria-live="polite">Ready</span>
    </div>
  </div>

  <!-- Scroll to bottom button -->
  <button id="scrollBtn" title="Scroll to bottom">â¬‡</button>

  <script>
    const API_BASE = "https://marty-backend.onrender.com";
    const chat = document.getElementById("chat");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("message");
    const micBtn = document.getElementById("mic");
    const sendBtn = document.getElementById("sendBtn");
    const player = document.getElementById("player");
    const scrollBtn = document.getElementById("scrollBtn");
    const AVATAR_SRC = "marty.jpg?t=1";
    let userHasInteracted = false;

    function scrollToBottom() {
      chat.scrollTop = chat.scrollHeight;
    }

    function addRow(who) {
      const row = document.createElement("div");
      row.className = `row ${who}`;
      row.setAttribute("role", "group");
      row.setAttribute("aria-label", who === "bot" ? "Marty message" : "Your message");

      if (who === "bot") {
        const img = document.createElement("img");
        img.src = AVATAR_SRC;
        img.alt = "Marty avatar";
        img.className = "avatar";
        row.appendChild(img);
      } else {
        const spacer = document.createElement("div");
        spacer.style.width = "40px";
        spacer.style.height = "40px";
        row.appendChild(spacer);
      }
      return row;
    }

    function addBubble(text, who) {
      const row = addRow(who);
      const bubble = document.createElement("div");
      bubble.className = "msg";
      bubble.textContent = text;
      row.appendChild(bubble);
      chat.appendChild(row);
      scrollToBottom();
      return bubble;
    }

    // --- Typing indicator ---
    function addTypingBubble() {
      const row = addRow("bot");
      const bubble = document.createElement("div");
      bubble.className = "msg typing";
      const wrapper = document.createElement("span");
      wrapper.className = "dots";
      wrapper.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      bubble.appendChild(wrapper);
      row.appendChild(bubble);
      chat.appendChild(row);
      scrollToBottom();

      // return a cleanup function to remove typing bubble
      return () => row.remove();
    }

    async function sendToMarty(text) {
      const res = await fetch(`${API_BASE}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });
      if (!res.ok) throw new Error("Server error: " + res.status);
      return res.json();
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      userHasInteracted = true;

      const text = input.value.trim();
      if (!text) return;

      const mine = addBubble(text, "me");
      mine.parentElement.classList.add("me");
      mine.classList.add("me");

      input.value = "";

      // Show typing dots while waiting
      const removeTyping = addTypingBubble();

      sendBtn.disabled = true;
      micBtn.disabled = true;

      try {
        const data = await sendToMarty(mine.textContent);

        // Replace typing with final message
        removeTyping();
        const reply = addBubble(data.text || "(no response)", "bot");
        reply.parentElement.classList.add("bot");
        reply.classList.add("bot");

        if (data.audioUrl) {
          player.src = `${API_BASE}${data.audioUrl}?t=${Date.now()}`;
          if (userHasInteracted) {
            try { await player.play(); } catch {}
          }
        }
      } catch (err) {
        removeTyping();
        const errBubble = addBubble("Error talking to server.", "bot");
        errBubble.parentElement.classList.add("bot");
        errBubble.classList.add("bot");
        console.error(err);
        alert("Couldnâ€™t reach the server. Please try again.");
      } finally {
        sendBtn.disabled = false;
        micBtn.disabled = false;
        input.focus();
      }
    });

    micBtn.addEventListener("click", () => {
      userHasInteracted = true;
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Speech recognition not supported in this browser. Try Chrome on desktop.");
        return;
      }

      const rec = new SpeechRecognition();
      rec.lang = "en-US";
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      micBtn.disabled = true;
      micBtn.textContent = "ðŸŽ™ï¸";
      rec.start();

      rec.onresult = () => {
        input.value = rec.results[0][0].transcript;
        form.requestSubmit();
      };
      rec.onend = () => { micBtn.disabled = false; micBtn.textContent = "ðŸŽ¤"; };
      rec.onerror = (e) => { console.error("Speech error:", e.error); micBtn.disabled = false; micBtn.textContent = "ðŸŽ¤"; alert("Mic error: " + e.error); };
    });

    // Show/hide scroll-to-bottom button
    chat.addEventListener("scroll", () => {
      const atBottom = chat.scrollTop + chat.clientHeight >= chat.scrollHeight - 20;
      scrollBtn.style.display = atBottom ? "none" : "flex";
    });
    scrollBtn.addEventListener("click", scrollToBottom);
  </script>
</body>
</html>