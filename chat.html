<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Marty â€“ Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="marty-avatar.jpg" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #0b0c10; color:#eaf0f1; }
    .shell { max-width: 800px; margin: 0 auto; padding: 24px 16px 32px; }
    nav { margin-bottom: 24px; text-align: center; }
    nav a { color:#66fcf1; margin: 0 12px; text-decoration: none; }
    nav a:hover { text-decoration: underline; }

    .hero { text-align: center; margin-top: 8px; }
    .marty-video {
      width: 200px; height: 200px; border-radius: 50%;
      border: 3px solid #66fcf1; object-fit: cover;
      transition: box-shadow .3s ease, opacity .35s ease, filter .35s ease;
    }
    .marty-video.speaking {
      box-shadow: 0 0 20px 6px rgba(102,252,241,.7);
      animation: pulseGlow 1.5s infinite alternate; opacity: 1; filter: none;
    }
    .marty-video.fadeout {
      animation: none; box-shadow: 0 0 8px 2px rgba(102,252,241,.35);
      opacity: .9; filter: saturate(.9);
    }
    @keyframes pulseGlow { from { box-shadow: 0 0 10px 2px rgba(102,252,241,.5);} to { box-shadow: 0 0 20px 6px rgba(102,252,241,.9);} }

    h1 { margin: 12px 0 16px; text-align: center; }

    .chat {
      background: #111417; border-radius: 16px; padding: 16px;
      min-height: 50vh; display: flex; flex-direction: column; gap: 12px;
      overflow-y: auto; scroll-behavior: smooth;
    }

    .row { display: flex; align-items: flex-start; gap: 8px; }
    .row.me { justify-content: flex-end; }
    .msg { padding: 12px 14px; border-radius: 12px; max-width: 75%; word-wrap: break-word;
           animation: fadeInUp 220ms ease-out both; }
    .me .msg { background:#1f2833; }
    .bot .msg { background:#0e6655; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(6px); } to { opacity:1; transform: translateY(0); } }

    form { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 12px 0; align-items: center; }
    input[type="text"] { padding: 12px; border-radius: 10px; border: 1px solid #2b2f36; background:#0d1117; color:#eaf0f1; }
    button { padding: 12px 16px; border: 0; border-radius: 10px; background:#45a29e; color:#0b0c10; font-weight: 700; cursor:pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Push-to-talk mic button */
    #mic.listening {
      background: #e85d75 !important; 
      color:#fff; animation: micPulse 1s infinite;
    }
    @keyframes micPulse {
      0% { box-shadow: 0 0 0 0 rgba(232,93,117,.6); }
      70%{ box-shadow: 0 0 0 14px rgba(232,93,117,0); }
      100%{ box-shadow: 0 0 0 0 rgba(232,93,117,0); }
    }

    /* Speaking visualiser bars */
    .speaking-bars { display:inline-flex; align-items:flex-end; gap:3px; height:16px; margin-left:8px; }
    .speaking-bars .bar { width:3px; height:4px; background:#66fcf1; border-radius:1px; transition: height .1s ease; }

    audio { display:none; }
  </style>
</head>
<body>
  <div class="shell">
    <nav aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="chat.html" aria-current="page">Chat</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
    </nav>

    <div class="hero">
      <video id="martyVideo" loop muted playsinline class="marty-video">
        <source src="marty-loop-small.mp4?t=1" type="video/mp4">
      </video>
    </div>

    <h1>Chat with Marty</h1>

    <div id="chat" class="chat" aria-live="polite"></div>

    <form id="chatForm" autocomplete="off">
      <input id="message" type="text" placeholder="Say hi to Martyâ€¦" />
      <button type="submit" id="sendBtn">Send</button>
      <button type="button" id="mic" aria-label="Hold to talk" title="Hold to talk">ðŸŽ¤</button>
    </form>

    <audio id="player" preload="auto" crossorigin="anonymous"></audio>
    <button id="playFallback" style="display:none;margin-top:8px;">â–¶ Play reply</button>
  </div>

  <script>
    const API_BASE = "https://marty-backend.onrender.com";
    const chat = document.getElementById("chat");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("message");
    const micBtn = document.getElementById("mic");
    const sendBtn = document.getElementById("sendBtn");
    const player = document.getElementById("player");
    const playFallback = document.getElementById("playFallback");
    const martyVideo = document.getElementById("martyVideo");

    let userHasInteracted = false;

    function scrollToBottom(){ chat.scrollTop = chat.scrollHeight; }
    function addBubble(text, who){
      const row=document.createElement("div"); row.className=`row ${who}`;
      const bubble=document.createElement("div"); bubble.className="msg"; bubble.textContent=text;
      row.appendChild(bubble); chat.appendChild(row); scrollToBottom(); return bubble;
    }
    async function sendToMarty(text){
      const res=await fetch(`${API_BASE}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:text})});
      if(!res.ok) throw new Error("Server error "+res.status);
      return res.json();
    }
    function resolveAudioUrl(u){ if(!u) return null; return /^https?:\/\//i.test(u)?(u):(`${API_BASE}${u}`); }
    async function tryPlay(){ try{ await player.play(); playFallback.style.display="none"; } catch{ playFallback.style.display="inline-block"; } }
    playFallback.addEventListener("click",()=>tryPlay());

    /* ---------- Single, reusable Web Audio graph (FIX) ---------- */
    let audioCtx = null, sourceNode = null, analyser = null, dataArray = null, rafId = null;

    function ensureAudioGraph() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (!sourceNode) {
        // Create ONCE per page lifetime
        sourceNode = audioCtx.createMediaElementSource(player);
      }
      if (!analyser) {
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 64;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        // Connect once: player -> analyser -> destination
        sourceNode.connect(analyser);
        analyser.connect(audioCtx.destination);
      }
    }

    function animateBars(viz){
      if (!analyser) return;
      analyser.getByteFrequencyData(dataArray);
      const avgLow=dataArray.slice(0,5).reduce((a,b)=>a+b,0)/5;
      const avgMid=dataArray.slice(5,15).reduce((a,b)=>a+b,0)/10;
      const avgHigh=dataArray.slice(15,30).reduce((a,b)=>a+b,0)/15;
      const bars=viz.querySelectorAll(".bar");
      if(bars.length>=4){
        bars[0].style.height=Math.max(4,avgLow/8)+"px";
        bars[1].style.height=Math.max(4,avgMid/8)+"px";
        bars[2].style.height=Math.max(4,avgHigh/8)+"px";
        bars[3].style.height=Math.max(4,(avgMid+avgHigh)/16)+"px";
      }
      rafId=requestAnimationFrame(()=>animateBars(viz));
    }
    function stopBars(){ if(rafId) cancelAnimationFrame(rafId); rafId=null; }

    /* ---------- Video glow control ---------- */
    function startSpeakingEffect(){
      try{ martyVideo.currentTime = 0; }catch{}
      martyVideo.play().catch(()=>{});
      martyVideo.classList.remove("fadeout");
      martyVideo.classList.add("speaking");
    }
    function stopSpeakingEffect(){
      martyVideo.classList.remove("speaking");
      martyVideo.classList.add("fadeout");
      setTimeout(()=>{ try{ martyVideo.pause(); }catch{} }, 350);
      stopBars();
    }

    /* ---------- Chat flow ---------- */
    form.addEventListener("submit",async e=>{
      e.preventDefault(); userHasInteracted=true;
      const text=input.value.trim(); if(!text) return;
      addBubble(text,"me"); input.value="";
      const reply=addBubble("â€¦thinkingâ€¦","bot");

      try{
        const data=await sendToMarty(text);
        reply.textContent=data.text||"(no response)";

        if(data.audioUrl){
          const viz=document.createElement("span");
          viz.className="speaking-bars";
          viz.innerHTML='<span class="bar"></span><span class="bar"></span><span class="bar"></span><span class="bar"></span>';
          reply.appendChild(viz);

          const url = resolveAudioUrl(data.audioUrl);
          if (url) {
            player.crossOrigin = "anonymous";
            player.src = url;

            player.addEventListener("playing", async () => {
              viz.style.display = "inline-flex";
              ensureAudioGraph();            // <-- create/reuse ONCE
              try { await audioCtx.resume(); } catch {}
              animateBars(viz);
              startSpeakingEffect();
            }, { once: true });

            const stopOnce = () => { viz.style.display="none"; stopSpeakingEffect(); };
            player.addEventListener("ended",  stopOnce, { once: true });
            player.addEventListener("pause",  stopOnce, { once: true });
            player.addEventListener("error",  stopOnce, { once: true });

            await tryPlay();
          }
        }
      }catch(err){
        reply.textContent="Error talking to Marty."; console.error(err);
      }
    });

    /* ---------- Push-to-Talk mic ---------- */
    const RECO_LANG="en-GB"; let rec=null,listening=false,stopping=false,interimText="",finalText="";
    function createRecognizer(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){ alert("Speech recognition not supported. Try Chrome."); return null; }
      const r=new SR(); r.lang=RECO_LANG; r.interimResults=true; r.continuous=true; r.maxAlternatives=1;
      r.onresult=e=>{
        for(let i=e.resultIndex;i<e.results.length;i++){
          const res=e.results[i];
          if(res.isFinal){ finalText+=res[0].transcript+" "; interimText=""; }
          else{ interimText=res[0].transcript; }
        }
        input.value=(finalText+" "+interimText).trim();
      };
      r.onend=()=>{ if(stopping){ stopping=false; micBtn.classList.remove("listening"); listening=false; if(input.value.trim()) form.requestSubmit(); } else { micBtn.classList.remove("listening"); listening=false; } };
      r.onerror=e=>{ console.error("Speech error:",e.error); micBtn.classList.remove("listening"); listening=false; stopping=false; if(e.error==="not-allowed") alert("Mic permission blocked. Allow mic in browser."); };
      return r;
    }
    function startPTT(ev){ ev.preventDefault(); userHasInteracted=true; if(listening) return; rec=createRecognizer(); if(!rec) return; interimText=""; finalText=""; input.value=""; stopping=false; listening=true; micBtn.classList.add("listening"); try{ rec.start(); }catch{} }
    function stopPTT(){ if(!listening||!rec) return; stopping=true; try{ rec.stop(); }catch{} }
    micBtn.addEventListener("mousedown",startPTT); window.addEventListener("mouseup",stopPTT);
    micBtn.addEventListener("touchstart",e=>{ startPTT(e); },{passive:false}); window.addEventListener("touchend",()=>{ stopPTT(); });
  </script>
</body>
</html>

