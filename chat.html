
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Marty â€“ Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #0b0c10; color: #eaf0f1; }
    .shell { max-width: 800px; margin: 0 auto; padding: 24px 16px 32px; }
    nav { margin-bottom: 24px; text-align: center; }
    nav a { color: #66fcf1; margin: 0 12px; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    .hero { text-align: center; margin-top: 8px; }

    .marty-video {
      width: 200px; height: 200px;
      border-radius: 50%;
      border: 3px solid #66fcf1;
      object-fit: cover;
      /* smooth visual transitions */
      transition: box-shadow 0.3s ease, opacity 0.35s ease, filter 0.35s ease;
      opacity: 0.95;               /* calm idle look */
      filter: saturate(0.95);
    }
    /* Glow + active look while speaking */
    .marty-video.speaking {
      box-shadow: 0 0 20px 6px rgba(102, 252, 241, 0.7);
      animation: pulseGlow 1.5s infinite alternate;
      opacity: 1;
      filter: none;
    }
    /* Fade-out when finishing speaking (pause on last frame) */
    .marty-video.fadeout {
      animation: none;                 /* stop glow animation */
      box-shadow: 0 0 8px 2px rgba(102, 252, 241, 0.35);
      opacity: 0.88;                   /* gentle fade, not to 0 */
      filter: saturate(0.9);
    }

    .avatar.speaking {
      box-shadow: 0 0 12px 4px rgba(102, 252, 241, 0.7);
      animation: pulseGlow 1.5s infinite alternate;
    }

    @keyframes pulseGlow {
      from { box-shadow: 0 0 10px 2px rgba(102, 252, 241, 0.5); }
      to   { box-shadow: 0 0 20px 6px rgba(102, 252, 241, 0.9); }
    }

    h1 { margin: 12px 0 16px; text-align: center; }

    .chat {
      background: #111417; border-radius: 16px; padding: 16px;
      min-height: 50vh; display: flex; flex-direction: column; gap: 12px;
      overflow-y: auto; scroll-behavior: smooth;
    }

    .row { display: flex; align-items: flex-start; gap: 8px; }
    .row.me { justify-content: flex-end; }
    .avatar {
      width: 40px; height: 40px;
      border-radius: 50%;
      flex: 0 0 40px;
      object-fit: cover;
      border: 2px solid #2b2f36;
      transition: box-shadow 0.3s ease;
    }
    .spacer { width: 40px; height: 40px; }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    .msg {
      padding: 12px 14px; border-radius: 12px; max-width: 75%; word-wrap: break-word;
      opacity: 0; animation: fadeInUp 220ms ease-out both;
    }
    .me .msg { background: #1f2833; }
    .bot .msg { background: #0e6655; position: relative; }

    /* Typing dots */
    .typing.msg { background: #0e6655; }
    .dots { display: inline-flex; gap: 4px; vertical-align: middle; }
    .dot { width: 6px; height: 6px; background: #cfeee9; border-radius: 50%; opacity: 0.6; animation: bounce 1s infinite ease-in-out; }
    .dot:nth-child(2) { animation-delay: .15s; }
    .dot:nth-child(3) { animation-delay: .3s; }
    @keyframes bounce { 0%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-4px); opacity: 1; } }

    form { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 12px 0; align-items: center; }
    input[type="text"] { padding: 12px; border-radius: 10px; border: 1px solid #2b2f36; background:#0d1117; color:#eaf0f1; }
    button { padding: 12px 16px; border: 0; border-radius: 10px; background: #45a29e; color: #0b0c10; font-weight: 700; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    audio { display: none; }

    /* Real audio bars */
    .speaking-bars {
      display: inline-flex; align-items: flex-end; gap: 3px; height: 16px; margin-left: 8px;
    }
    .speaking-bars .bar {
      width: 3px;
      height: 4px;
      background: #66fcf1;
      border-radius: 1px;
      transition: height 0.1s ease;
    }

    #scrollBtn {
      position: fixed; bottom: 90px; right: 20px;
      background: #45a29e; color: #0b0c10; border: none; border-radius: 50%;
      width: 50px; height: 50px; font-size: 24px;
      display: none; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    #scrollBtn:hover { background: #66fcf1; }

    #mic.listening {
      background: #e85d75; color: #0b0c10; animation: micPulse 1s infinite;
    }
    @keyframes micPulse {
      0%   { box-shadow: 0 0 0 0 rgba(232,93,117,0.6); }
      70%  { box-shadow: 0 0 0 14px rgba(232,93,117,0); }
      100% { box-shadow: 0 0 0 0 rgba(232,93,117,0); }
    }
  </style>
</head>
<body>
  <div class="shell">
    <nav aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="chat.html" aria-current="page">Chat</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
    </nav>

    <div class="hero">
      <video id="martyVideo" loop muted playsinline class="marty-video">
        <source src="marty-loop-small.mp4?t=1" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>

    <h1>Chat with Marty</h1>

    <div id="chat" class="chat" aria-live="polite" aria-label="Conversation"></div>

    <form id="chatForm" autocomplete="off">
      <input id="message" type="text" placeholder="Say hi to Martyâ€¦" />
      <button type="submit" id="sendBtn">Send</button>
      <button type="button" id="mic" aria-label="Hold to talk" title="Hold to talk">ðŸŽ¤</button>
    </form>

    <audio id="player" preload="auto"></audio>
  </div>

  <button id="scrollBtn" title="Scroll to bottom">â¬‡</button>

  <script>
    const API_BASE = "https://marty-backend.onrender.com";
    const AVATAR_SRC = "marty-avatar.jpg?t=1";

    const chat = document.getElementById("chat");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("message");
    const micBtn = document.getElementById("mic");
    const sendBtn = document.getElementById("sendBtn");
    const player = document.getElementById("player");
    const scrollBtn = document.getElementById("scrollBtn");
    const martyVideo = document.getElementById("martyVideo");

    let userHasInteracted = false;
    let lastBotAvatar = null;

    function scrollToBottom() { chat.scrollTop = chat.scrollHeight; }

    function addRow(who) {
      const row = document.createElement("div");
      row.className = `row ${who}`;
      if (who === "bot") {
        const img = document.createElement("img");
        img.src = AVATAR_SRC;
        img.alt = "Marty avatar";
        img.className = "avatar";
        row.appendChild(img);
        lastBotAvatar = img;
      } else {
        const spacer = document.createElement("div");
        spacer.className = "spacer";
        row.appendChild(spacer);
      }
      return row;
    }

    function addBubble(text, who) {
      const row = addRow(who);
      const bubble = document.createElement("div");
      bubble.className = "msg";
      bubble.textContent = text;
      row.appendChild(bubble);
      chat.appendChild(row);
      scrollToBottom();
      return bubble;
    }

    function addTypingBubble() {
      const row = addRow("bot");
      const bubble = document.createElement("div");
      bubble.className = "msg typing";
      const wrapper = document.createElement("span");
      wrapper.className = "dots";
      wrapper.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      bubble.appendChild(wrapper);
      row.appendChild(bubble);
      chat.appendChild(row);
      scrollToBottom();
      return { row, bubble, remove: () => row.remove(), replaceWith: (node) => row.replaceWith(node) };
    }

    async function sendToMarty(text) {
      const res = await fetch(`${API_BASE}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });
      if (!res.ok) throw new Error("Server error: " + res.status);
      return res.json();
    }

    /* ---------- Real-time audio bars via Web Audio API ---------- */
    let audioCtx, analyser, dataArray, sourceNode, rafId;
    function setupAudioAnalyser() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (sourceNode) {
        try { sourceNode.disconnect(); } catch {}
        try { analyser && analyser.disconnect(); } catch {}
      }
      sourceNode = audioCtx.createMediaElementSource(player);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 64;
      const bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);
      sourceNode.connect(analyser);
      analyser.connect(audioCtx.destination);
    }
    function animateBars(vizElement) {
      if (!analyser) return;
      analyser.getByteFrequencyData(dataArray);
      const avgLow  = dataArray.slice(0, 5).reduce((a,b)=>a+b,0)/5;
      const avgMid  = dataArray.slice(5, 15).reduce((a,b)=>a+b,0)/10;
      const avgHigh = dataArray.slice(15, 30).reduce((a,b)=>a+b,0)/15;
      const bars = vizElement.querySelectorAll(".bar");
      if (bars.length >= 4) {
        bars[0].style.height = Math.max(4, avgLow  / 8)  + "px";
        bars[1].style.height = Math.max(4, avgMid  / 8)  + "px";
        bars[2].style.height = Math.max(4, avgHigh / 8)  + "px";
        bars[3].style.height = Math.max(4, (avgMid+avgHigh)/16) + "px";
      }
      rafId = requestAnimationFrame(() => animateBars(vizElement));
    }
    function stopBars() {
      if (rafId) cancelAnimationFrame(rafId);
    }

    /* ---------- Speaking visual effects (video + avatar) ---------- */
    function startSpeakingEffect() {
      // rewind to start BEFORE each play so it doesn't resume mid-frame
      try { martyVideo.currentTime = 0; } catch {}
      martyVideo.play().catch(() => {});
      martyVideo.classList.remove("fadeout");  // remove any fade from prior speak
      martyVideo.classList.add("speaking");
      if (lastBotAvatar) lastBotAvatar.classList.add("speaking");
    }

    // Smooth fade then pause on last frame (no snap to 0)
    function stopSpeakingEffect() {
      martyVideo.classList.remove("speaking");
      martyVideo.classList.add("fadeout");
      if (lastBotAvatar) lastBotAvatar.classList.remove("speaking");
      // Wait for the CSS fade to complete (~350ms), then pause (keeps current frame)
      setTimeout(() => {
        try { martyVideo.pause(); } catch {}
        // DO NOT reset currentTime here â€” we want the "freeze frame" look.
      }, 360);
      stopBars();
    }

    /* ---------- Chat flow ---------- */
    let lastViz = null; // track viz of the current bot message

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      userHasInteracted = true;
      const text = input.value.trim();
      if (!text) return;

      addBubble(text, "me");
      input.value = "";

      let typing = addTypingBubble();
      let typingActive = true;

      sendBtn.disabled = true;
      micBtn.disabled = true;

      try {
        const data = await sendToMarty(text);
        if (typingActive) { typing.remove(); typingActive = false; }

        const reply = addBubble(data.text || "(no response)", "bot");
        const viz = document.createElement("span");
        viz.className = "speaking-bars";
        viz.innerHTML = '<span class="bar"></span><span class="bar"></span><span class="bar"></span><span class="bar"></span>';
        reply.appendChild(viz);
        lastViz = viz;

        if (data.audioUrl) {
          player.src = `${API_BASE}${data.audioUrl}?t=${Date.now()}`;

          const showViz = async () => {
            if (lastViz) {
              lastViz.style.display = "inline-flex";
              setupAudioAnalyser();
              try { await audioCtx.resume(); } catch {}
              animateBars(lastViz);
            }
            startSpeakingEffect();
          };
          const hideViz = () => {
            if (lastViz) lastViz.style.display = "none";
            stopSpeakingEffect();
          };

          player.addEventListener("playing", showViz, { once: true });
          player.addEventListener("ended",  hideViz, { once: true });
          player.addEventListener("pause",  hideViz, { once: true });
          player.addEventListener("error",  hideViz, { once: true });

          try { if (userHasInteracted) await player.play(); } catch {}
        }
      } catch (err) {
        if (typingActive) { typing.remove(); typingActive = false; }
        addBubble("Error talking to server.", "bot");
        console.error(err);
      } finally {
        sendBtn.disabled = false;
        micBtn.disabled = false;
        input.focus();
      }
    });
  </script>
</body>
</html>
