<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Marty â€“ Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #0b0c10; color: #eaf0f1; }
    .shell { max-width: 800px; margin: 0 auto; padding: 24px 16px 32px; }
    nav { margin-bottom: 24px; text-align: center; }
    nav a { color: #66fcf1; margin: 0 12px; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    .hero { text-align: center; margin-top: 8px; }

    .marty-video {
      width: 200px; height: 200px;
      border-radius: 50%;
      border: 3px solid #66fcf1;
      object-fit: cover;
      transition: box-shadow 0.3s ease, opacity 0.35s ease, filter 0.35s ease;
    }
    .marty-video.speaking {
      box-shadow: 0 0 20px 6px rgba(102, 252, 241, 0.7);
      animation: pulseGlow 1.5s infinite alternate;
    }
    @keyframes pulseGlow {
      from { box-shadow: 0 0 10px 2px rgba(102, 252, 241, 0.5); }
      to   { box-shadow: 0 0 20px 6px rgba(102, 252, 241, 0.9); }
    }

    h1 { margin: 12px 0 16px; text-align: center; }

    .chat {
      background: #111417; border-radius: 16px; padding: 16px;
      min-height: 50vh; display: flex; flex-direction: column; gap: 12px;
      overflow-y: auto; scroll-behavior: smooth;
    }

    .row { display: flex; align-items: flex-start; gap: 8px; }
    .row.me { justify-content: flex-end; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; flex: 0 0 40px; object-fit: cover; border: 2px solid #2b2f36; }
    .spacer { width: 40px; height: 40px; }

    .msg { padding: 12px 14px; border-radius: 12px; max-width: 75%; word-wrap: break-word; animation: fadeInUp 220ms ease-out both; }
    .me .msg { background: #1f2833; }
    .bot .msg { background: #0e6655; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    form { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 12px 0; align-items: center; }
    input[type="text"] { padding: 12px; border-radius: 10px; border: 1px solid #2b2f36; background:#0d1117; color:#eaf0f1; }
    button { padding: 12px 16px; border: 0; border-radius: 10px; background: #45a29e; color: #0b0c10; font-weight: 700; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Mic push-to-talk button */
    #mic.listening {
      background: #e85d75 !important; 
      color: #fff;
      animation: micPulse 1s infinite;
    }
    @keyframes micPulse {
      0%   { box-shadow: 0 0 0 0 rgba(232,93,117,0.6); }
      70%  { box-shadow: 0 0 0 14px rgba(232,93,117,0); }
      100% { box-shadow: 0 0 0 0 rgba(232,93,117,0); }
    }

    audio { display: none; }
  </style>
</head>
<body>
  <div class="shell">
    <nav aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="chat.html" aria-current="page">Chat</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
    </nav>

    <div class="hero">
      <video id="martyVideo" loop muted playsinline class="marty-video">
        <source src="marty-loop-small.mp4?t=1" type="video/mp4">
      </video>
    </div>

    <h1>Chat with Marty</h1>

    <div id="chat" class="chat" aria-live="polite"></div>

    <form id="chatForm" autocomplete="off">
      <input id="message" type="text" placeholder="Say hi to Martyâ€¦" />
      <button type="submit" id="sendBtn">Send</button>
      <button type="button" id="mic" aria-label="Hold to talk" title="Hold to talk">ðŸŽ¤</button>
    </form>

    <audio id="player" preload="auto" crossorigin="anonymous"></audio>
    <button id="playFallback" style="display:none;margin-top:8px;">â–¶ Play reply</button>
  </div>

  <script>
    const API_BASE = "https://marty-backend.onrender.com";
    const chat = document.getElementById("chat");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("message");
    const micBtn = document.getElementById("mic");
    const sendBtn = document.getElementById("sendBtn");
    const player = document.getElementById("player");
    const playFallback = document.getElementById("playFallback");

    let userHasInteracted = false;

    function scrollToBottom() { chat.scrollTop = chat.scrollHeight; }
    function addBubble(text, who) {
      const row = document.createElement("div");
      row.className = `row ${who}`;
      const bubble = document.createElement("div");
      bubble.className = "msg";
      bubble.textContent = text;
      row.appendChild(bubble);
      chat.appendChild(row);
      scrollToBottom();
      return bubble;
    }

    async function sendToMarty(text) {
      const res = await fetch(`${API_BASE}/chat`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });
      if (!res.ok) throw new Error("Server error " + res.status);
      return res.json();
    }

    // Audio helpers
    function resolveAudioUrl(u) {
      if (!u) return null;
      if (/^https?:\/\//i.test(u)) return u;
      return `${API_BASE}${u}`;
    }
    async function tryPlay() {
      try { await player.play(); playFallback.style.display = "none"; }
      catch { playFallback.style.display = "inline-block"; }
    }
    playFallback.addEventListener("click", () => tryPlay());

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      userHasInteracted = true;
      const text = input.value.trim();
      if (!text) return;
      addBubble(text, "me");
      input.value = "";

      const replyBubble = addBubble("â€¦thinkingâ€¦", "bot");
      try {
        const data = await sendToMarty(text);
        replyBubble.textContent = data.text || "(no response)";
        if (data.audioUrl) {
          player.src = resolveAudioUrl(data.audioUrl);
          await tryPlay();
        }
      } catch (err) {
        replyBubble.textContent = "Error contacting Marty.";
      }
    });

    /* ---------- Push-to-Talk microphone ---------- */
    const RECO_LANG = "en-GB";
    let rec = null, listening = false, stopping = false, interimText = "", finalText = "";

    function createRecognizer() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert("Speech recognition not supported. Try Chrome."); return null; }
      const r = new SR();
      r.lang = RECO_LANG; r.interimResults = true; r.continuous = true; r.maxAlternatives = 1;

      r.onresult = (e) => {
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const res = e.results[i];
          if (res.isFinal) { finalText += res[0].transcript + " "; interimText = ""; }
          else { interimText = res[0].transcript; }
        }
        input.value = (finalText + " " + interimText).trim();
      };

      r.onend = () => {
        if (stopping) {
          stopping = false; micBtn.classList.remove("listening"); listening = false;
          if (input.value.trim()) form.requestSubmit();
        } else {
          micBtn.classList.remove("listening"); listening = false;
        }
      };

      r.onerror = (e) => {
        console.error("Speech error:", e.error);
        micBtn.classList.remove("listening"); listening = false; stopping = false;
        if (e.error === "not-allowed") alert("Mic permission blocked. Allow mic in browser.");
      };
      return r;
    }

    function startPTT(ev) {
      ev.preventDefault();
      if (listening) return;
      rec = createRecognizer();
      if (!rec) return;
      interimText = ""; finalText = ""; input.value = "";
      stopping = false; listening = true;
      micBtn.classList.add("listening");
      try { rec.start(); } catch {}
    }

    function stopPTT() {
      if (!listening || !rec) return;
      stopping = true;
      try { rec.stop(); } catch {}
    }

    micBtn.addEventListener("mousedown", startPTT);
    window.addEventListener("mouseup", stopPTT);
    micBtn.addEventListener("touchstart", (e) => { startPTT(e); }, { passive: false });
    window.addEventListener("touchend", () => { stopPTT(); });
  </script>
</body>
</html>


